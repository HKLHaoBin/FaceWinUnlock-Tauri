name: Build Tauri App for Windows
on:
  push:
    branches:
      - main
permissions:
  contents: write
  actions: write
  attestations: write
  deployments: write
  packages: write
  id-token: write

env:
  VCPKG_ROOT: C:\vcpkg
  VCPKG_DEFAULT_BINARY_CACHE: C:\vcpkg\archives
  VCPKGRS_TRIPLET: x64-windows

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: './UI/package-lock.json'

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache vcpkg
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: |
            C:\vcpkg\installed\x64-windows
            C:\vcpkg\archives
          key: vcpkg-opencv-x64-windows-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            vcpkg-opencv-x64-windows-

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            ./UI/src-tauri -> target
            ./Server -> target

      - name: Install vcpkg
        run: |
          if (-not (Test-Path "C:\vcpkg")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          }
          C:\vcpkg\bootstrap-vcpkg.bat

      - name: Create vcpkg binary cache directory
        run: |
          New-Item -ItemType Directory -Force -Path "C:\vcpkg\archives" | Out-Null
          Write-Host "Created vcpkg binary cache directory: C:\vcpkg\archives"

      - name: Install OpenCV via vcpkg
        run: python scripts/install_opencv.py

      - name: Install frontend dependencies
        run: cd UI && npm install

      - name: Prepare build resources
        run: powershell -ExecutionPolicy Bypass -File scripts\build-resources.ps1

      - name: Download AI models
        continue-on-error: true
        run: powershell -ExecutionPolicy Bypass -File scripts\download-models.ps1

      - name: Check model files
        run: |
          $resourcesDir = "UI\src-tauri\resources"
          $requiredFiles = @(
            "FaceWinUnlock-Tauri.dll",
            "face_detection_yunet_2023mar.onnx",
            "face_recognition_sface_2021dec.onnx"
          )
          Write-Host "检查必需的文件..." -ForegroundColor Cyan
          $missingFiles = @()
          foreach ($file in $requiredFiles) {
            $filePath = "$resourcesDir\$file"
            if (Test-Path $filePath) {
              $fileSize = [math]::Round((Get-Item $filePath).Length / 1MB, 2)
              Write-Host "  ✓ $file ($fileSize MB)" -ForegroundColor Green
            } else {
              $missingFiles += $file
              Write-Host "  ✗ $file (缺失)" -ForegroundColor Red
            }
          }
          Write-Host ""
          if ($missingFiles.Count -gt 0) {
            Write-Host "警告: 以下文件缺失: $($missingFiles -join ', ')" -ForegroundColor Yellow
            Write-Host "部分功能可能无法正常工作" -ForegroundColor Yellow
            Write-Host "用户需要在首次运行时手动下载缺失的模型文件" -ForegroundColor Yellow
          } else {
            Write-Host "所有必需的文件已就绪" -ForegroundColor Green
          }

      - name: Copy OpenCV DLL
        run: |
          # x64-windows 是动态链接版本，需要复制 OpenCV DLL 到资源目录
          $opencvBinDir = "C:\vcpkg\installed\x64-windows\bin"
          $resourcesDir = "UI\src-tauri\resources"
          $targetDir = "UI\src-tauri\target\release"

          Write-Host "复制 OpenCV DLL..." -ForegroundColor Cyan

          # 确保目标目录存在
          if (-not (Test-Path $resourcesDir)) {
            New-Item -ItemType Directory -Force -Path $resourcesDir | Out-Null
          }

          # 首先尝试查找 opencv_world*.dll（合并版本）
          $opencvWorldDlls = Get-ChildItem -Path $opencvBinDir -Filter "opencv_world*.dll" -ErrorAction SilentlyContinue

          if ($opencvWorldDlls.Count -gt 0) {
            # 使用 opencv_world*.dll
            foreach ($dll in $opencvWorldDlls) {
              Write-Host "  复制 $($dll.Name)..." -ForegroundColor Yellow
              Copy-Item -Path $dll.FullName -Destination $resourcesDir -Force
              # 同时复制到 target/release 目录，确保运行时能找到
              Copy-Item -Path $dll.FullName -Destination $targetDir -Force
            }
          } else {
            # 使用模块化 DLL（opencv_*.dll）
            $opencvModuleDlls = Get-ChildItem -Path $opencvBinDir -Filter "opencv_*.dll" | Where-Object {
              $_.Name -match "^opencv_(core|imgproc|highgui|imgcodecs|video|videoio|dnn|features2d|calib3d|objdetect|ml|photo|flann|stitching)\d+\.dll$"
            }

            Write-Host "  找到 $($opencvModuleDlls.Count) 个 OpenCV 模块 DLL" -ForegroundColor Cyan
            foreach ($dll in $opencvModuleDlls) {
              Write-Host "  复制 $($dll.Name)..." -ForegroundColor Yellow
              Copy-Item -Path $dll.FullName -Destination $resourcesDir -Force
              # 同时复制到 target/release 目录，确保运行时能找到
              Copy-Item -Path $dll.FullName -Destination $targetDir -Force
            }

            if ($opencvModuleDlls.Count -eq 0) {
              Write-Host "  警告: 未找到任何 OpenCV DLL 文件" -ForegroundColor Yellow
            }
          }

          # 复制依赖的 DLL（如果有的话）
          $depDlls = @("libcrypto*.dll", "libssl*.dll", "zlib*.dll")
          foreach ($pattern in $depDlls) {
            $depFiles = Get-ChildItem -Path $opencvBinDir -Filter $pattern -ErrorAction SilentlyContinue
            foreach ($file in $depFiles) {
              Write-Host "  复制依赖 DLL $($file.Name)..." -ForegroundColor Yellow
              Copy-Item -Path $file.FullName -Destination $resourcesDir -Force
              Copy-Item -Path $file.FullName -Destination $targetDir -Force
            }
          }

          Write-Host "OpenCV DLL 复制完成" -ForegroundColor Green

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VCPKG_ROOT: C:\vcpkg
          VCPKG_INSTALLED_DIR: C:\vcpkg\installed
          VCPKGRS_TRIPLET: x64-windows
          OpenCV_DIR: C:\vcpkg\installed\x64-windows\share\opencv4
          OPENCV_LINK_LIBS: dylib
        with:
          projectPath: './UI'
          tagName: v__VERSION__
          releaseName: 'FaceWinUnlock v__VERSION__'
          releaseBody: |
            ## FaceWinUnlock v__VERSION__

            自动构建版本，发布于：__DATE__

            ### 主要功能
            - 面容识别解锁
            - 多账户支持
            - 活体检测
            - 系统级集成

            ### 下载说明
            请选择适合您系统的安装包进行下载。

            **注意**：本软件需要管理员权限运行，请确保以管理员身份安装。
          releaseDraft: false
          prerelease: false