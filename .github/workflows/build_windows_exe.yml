name: Build Tauri App for Windows
on:
  push:
    branches:
      - main
permissions:
  contents: write
  actions: write
  attestations: write
  deployments: write
  packages: write
  id-token: write

env:
  VCPKG_ROOT: C:\vcpkg
  VCPKG_DEFAULT_BINARY_CACHE: C:\vcpkg\archives
  VCPKGRS_TRIPLET: x64-windows-static

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: './UI/package-lock.json'

      - name: Rust setup
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache vcpkg
        uses: actions/cache@v4
        id: vcpkg-cache
        with:
          path: |
            C:\vcpkg\installed\x64-windows-static
            C:\vcpkg\archives
          key: vcpkg-opencv-x64-windows-static-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            vcpkg-opencv-x64-windows-static-

      - name: Cache Rust
        uses: swatinem/rust-cache@v2
        with:
          workspaces: |
            ./UI/src-tauri -> target
            ./Server -> target

      - name: Install vcpkg
        run: |
          if (-not (Test-Path "C:\vcpkg")) {
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          }
          C:\vcpkg\bootstrap-vcpkg.bat

      - name: Create vcpkg binary cache directory
        run: |
          New-Item -ItemType Directory -Force -Path "C:\vcpkg\archives" | Out-Null
          Write-Host "Created vcpkg binary cache directory: C:\vcpkg\archives"

      - name: Install OpenCV via vcpkg
        run: python scripts/install_opencv.py

      - name: Install frontend dependencies
        run: cd UI && npm install

      - name: Prepare build resources
        run: powershell -ExecutionPolicy Bypass -File scripts\build-resources.ps1

      - name: Download AI models
        continue-on-error: true
        run: powershell -ExecutionPolicy Bypass -File scripts\download-models.ps1

      - name: Check model files
        run: |
          $resourcesDir = "UI\src-tauri\resources"
          $requiredFiles = @(
            "FaceWinUnlock-Tauri.dll",
            "face_detection_yunet_2023mar.onnx",
            "face_recognition_sface_2021dec.onnx"
          )
          Write-Host "检查必需的文件..." -ForegroundColor Cyan
          $missingFiles = @()
          foreach ($file in $requiredFiles) {
            $filePath = "$resourcesDir\$file"
            if (Test-Path $filePath) {
              $fileSize = [math]::Round((Get-Item $filePath).Length / 1MB, 2)
              Write-Host "  ✓ $file ($fileSize MB)" -ForegroundColor Green
            } else {
              $missingFiles += $file
              Write-Host "  ✗ $file (缺失)" -ForegroundColor Red
            }
          }
          Write-Host ""
          if ($missingFiles.Count -gt 0) {
            Write-Host "警告: 以下文件缺失: $($missingFiles -join ', ')" -ForegroundColor Yellow
            Write-Host "部分功能可能无法正常工作" -ForegroundColor Yellow
            Write-Host "用户需要在首次运行时手动下载缺失的模型文件" -ForegroundColor Yellow
          } else {
            Write-Host "所有必需的文件已就绪" -ForegroundColor Green
          }

      - name: Copy OpenCV DLL
        run: |
          if (Test-Path "C:\vcpkg\installed\x64-windows-static\bin\opencv_world*.dll") {
            Copy-Item "C:\vcpkg\installed\x64-windows-static\bin\opencv_world*.dll" -Destination "UI\src-tauri\resources\"
            Write-Host "OpenCV DLL 复制成功"
          } else {
            Write-Host "警告: OpenCV DLL 未找到，跳过复制步骤" -ForegroundColor Yellow
          }

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VCPKG_ROOT: C:\vcpkg
          VCPKG_INSTALLED_DIR: C:\vcpkg\installed
          VCPKGRS_TRIPLET: x64-windows-static
          OpenCV_DIR: C:\vcpkg\installed\x64-windows-static\share\opencv4
          RUSTFLAGS: -C link-args=/DEFAULTLIB:libcmt.lib
        with:
          projectPath: './UI'
          tagName: v__VERSION__
          releaseName: 'FaceWinUnlock v__VERSION__'
          releaseBody: |
            ## FaceWinUnlock v__VERSION__

            自动构建版本，发布于：__DATE__

            ### 主要功能
            - 面容识别解锁
            - 多账户支持
            - 活体检测
            - 系统级集成

            ### 下载说明
            请选择适合您系统的安装包进行下载。

            **注意**：本软件需要管理员权限运行，请确保以管理员身份安装。
          releaseDraft: false
          prerelease: false